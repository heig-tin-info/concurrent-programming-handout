%% LyX 1.6.1 created this file.  For more info, see http://www.lyx.org/.
%% Do not edit unless you really know what you are doing.
\documentclass[a4paper,french]{report}
\usepackage[T1]{fontenc}
\usepackage[latin9]{inputenc}
\usepackage{listings}
\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}
\setlength{\parskip}{\medskipamount}
\setlength{\parindent}{0pt}
\usepackage{array}
\usepackage{float}
\usepackage{graphicx}
\usepackage{palatino}

\usepackage{dirtree}

\usepackage{booktabs}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% LyX specific LaTeX commands.
\newcommand{\noun}[1]{\textsc{#1}}
%% Because html converters don't know tabularnewline
\providecommand{\tabularnewline}{\\}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% User specified LaTeX commands.
\usepackage{RedsReport}

\usepackage{babel}
\addto\extrasfrench{\providecommand{\og}{\leavevmode\flqq~}\providecommand{\fg}{\ifdim\lastskip>\z@\unskip\fi~\frqq}}



\newcommand{\file}[1]{\texttt{#1}}
\newcommand{\folder}[1]{\texttt{#1}}
\newcommand{\ccode}[1]{\lstinline[basicstyle=\fontfamily{pcr}\selectfont\color{DefColor}\normalsize]{#1}}

\begin{document}

\title{QtrainSim}


\author{Kevin Georgy, Jéremie Ecoffey, Daniel Molla, Yann Thoma}


\date{21 mars 2018}

\maketitle
\newpage{}


\chapter*{Révisions}

%
\begin{table}[H]
\noindent \begin{centering}
\begin{tabular}{|c|c|c|>{\centering}p{8cm}|}
\hline 
\textbf{Date} & \textbf{Version} & \textbf{Ingénieur} & \textbf{Révision}\tabularnewline
\hline
\hline 
17/01/09 & v1.0 & KGY & Version initiale\tabularnewline
\hline 
26/03/09 & v1.1 & KGY & Ajout des plans des maquettes et des fonctionnalités GUI\tabularnewline
\hline 
05/03/12 & v1.2 & DMO & Mise à niveau de la documentation pour l'application Qt\tabularnewline
\hline 
22/03/12 & v1.3 & YTA & Nouvelles fonctionnalités de l'application et refonte d'une partie du document\tabularnewline
\hline
19/03/14 & v1.4 & YTA & Documentation de l'entrée clavier, passage à Qt5 et développement en C ou C++\tabularnewline
\hline
10/03/15 & v1.5 & YTA & Nouvelle arborescence (student\_c et student\_cpp) \tabularnewline
\hline
04/04/16 & v1.6 & YTA & Ajout d'un commentaire et d'un exemple d'utilisation de la classe \ccode{Locomotive} \tabularnewline
\hline
19/04/16 & v1.7 & YTA & Les maquettes sont maintenant les nouvelles maquettes telles que présentées dans le simulateur \tabularnewline
\hline
29/03/17 & v1.8 & YTA & Ajout d'un mot sur la gestion des sons, notamment pour les utilisateurs de Linux \tabularnewline
\hline
21/03/18 & v1.9 & YTA & Ajout d'un mot sur le fichier locomotive.h/cpp \tabularnewline
\hline
\end{tabular}
\par\end{centering}

\caption{Révisions}

\end{table}


\newpage{}


\chapter*{Conventions}


\section*{Mise en forme}
\begin{itemize}
\item Les noms propres sont écrits en \noun{Petites Capitales}
\item Les fichiers, dossiers ou commandes sont en \texttt{chasse fixe}
\item Les termes étrangers, les nouveaux termes ou les termes techniques
sont en \emph{emphasis}
\item Le \emph{listing} de code prend la forme suivante:

\begin{itemize}
\item Pour des commandes ou un extrait de code source:\\
\includegraphics[scale=0.33]{fig/convention_listing_txt}
\item Pour du code sources:\\
\includegraphics[scale=0.33]{fig/convention_listing_file}
\end{itemize}
\end{itemize}
\thispagestyle{empty}

\newpage{}

\tableofcontents{}


\chapter{Introduction}

\noun{Qtrainsim} est un programme de simulation des maquettes de train
\noun{Märklin}. Outre une utilisation en simulation pure, il peut également être exploité pour la commande de maquettes réelles, grâce à la librairie \noun{libtrainsim}. Le développeur peut contrôler l'exécution des locomotives, via du code C ou C++.

Ce document indique comment installer le simulateur sur différentes
plate-formes disponibles et comment l'utiliser.


\chapter{Installation}


\section{Mise en place}

Cette documentation se base sur l'environnement \noun{Qt SDK} 5.0-5.8. A priori le code devrait être fonctionnel sur des version postérieurs du \noun{Qt SDK}. Le simulateur est écrit en C++, en exploitant les différentes classes offertes par le \noun{Qt SDK}.

Un projet démontrant un fonctionnement basique peut \^etre récupéré sur le site web du reds: \url{http://reds.heig-vd.ch}. Le répertoire du projet contient:



\dirtree{%
.1 /.
.2 QTrainSim.
.3 src \DTcomment{ \begin{minipage}[t]{10cm}
Contient les fichiers sources
\end{minipage}}.
.4 studentcpp \DTcomment{ \begin{minipage}[t]{10cm}
Contient les fichiers à modifier pour un projet C++
\end{minipage}}.
.5 cppmain.cpp \DTcomment{ \begin{minipage}[t]{10cm}
Fichier à modifier pour un projet C++
\end{minipage}}.
.5 locomotive.h \DTcomment{ \begin{minipage}[t]{10cm}Fichiers (+.cpp) offrant une abstraction Locomotive\end{minipage}}.
.4 studentc \DTcomment{ \begin{minipage}[t]{10cm}
Contient les fichiers à modifier pour un projet C
\end{minipage}}.
.5 cmain.c \DTcomment{ \begin{minipage}[t]{10cm}
Fichier à modifier pour un projet C
\end{minipage}}.
.4 ....
.3 images\DTcomment{ \begin{minipage}[t]{10cm}
Contient les images
\end{minipage}}.
.4 ....
.3 sound \DTcomment{\begin{minipage}[t]{10cm}
Contient les sons
\end{minipage}}.
.4 ....
.3 Maquettes \DTcomment{ \begin{minipage}[t]{10cm}
Contient la description des maquettes
\end{minipage}}.
.4 ....
.3 QTrainSim.pro \DTcomment{ \begin{minipage}[t]{10cm}
Fichier de description du projet Qt
\end{minipage}}.
.3 qtrainsim.qrc \DTcomment{ \begin{minipage}[t]{10cm}
Fichier de ressources
\end{minipage}}.
.3 infosVoies.txt \DTcomment{ \begin{minipage}[t]{10cm}
Fichier de description des voies
\end{minipage}}.
}

Le projet peut \^etre compilé en ligne de commande ou via \noun{QtCreator}, l'IDE fourni avec l'environnement Qt. 

En ligne de commande, une fois placé dans le répertoire \folder{QTrainSim}, exécuter les commandes suivantes:

\begin{lstlisting}[style=cmd]
qmake # génération du Makefile
make  # compilation proprement dite
\end{lstlisting}

Par défaut la compilation se fait pour une simulation. Afin de compiler pour une exécution sur les maquettes réelles, la ligne de suivante doit \^etre décommentée dans le fichier \file{QTrainSim.pro}:

\begin{lstlisting}
CONFIG += MAQUETTE
\end{lstlisting}

Cette ligne permet de spécifier à l'application si elle doit utiliser
la librairie du simulateur ou la librairie des maquettes physiques.


Les opérations de compilation peuvent également \^etre exécutées gr\^ace à l'environnement \noun{QtCreator}. Il est conseillé de l'utiliser, notamment pour les possibilités de debug offertes. Le fichier de projet \file{QtrainSim.pro} peut \^etre ouvert via \noun{QtCreator}. L'application, après compilation, peut \^etre lancée via l'interface de \noun{QtCreator}, en mode \textit{release} ou \textit{debug}.

\newcommand{\attention}{\includegraphics[height=1em]{fig/attention}\hspace{.2cm}}

\attention Attention, avec \noun{QtCreator}, la compilation peut se faire en \emph{shadow build} ou non. Par défaut c'est le mode \emph{shadow build} qui est utilisé. Dans ce cas, il faut ajouter une étape de déploiement dans le panel \emph{Projects}, sous l'onglet \emph{Run}. Il faut simplement appeler 

\begin{lstlisting}[style=cmd]
make install
\end{lstlisting}

au déploiement, afin que tous les fichiers maquettes soient copiés dans le répertoire de destination. L'autre option consiste à décocher l'option \emph{shadow build} dans l'onglet \emph{Build} du panel \emph{Projects}.


Finalement, il est possible de développer en C ou C++. Pour un développement en C++, il faut travailler sur le fichier \file{src/studentcpp/cppmain.cpp}. Pour développer en C, il faut travailler dans \file{src/studentc/cmain.c}, et ajouter la ligne suivante dans le fichier \file{QtrainSim.pro}:

\begin{lstlisting}
CONFIG += CDEVELOP
\end{lstlisting}


Pour les utilisateurs de Linux, l'audio nécessite pulse audio. Il est possible de l'installer (sous les distributions Debian) ainsi:

\begin{lstlisting}[style=cmd]
sudo apt-get install libpulse-dev liglib2-dev
\end{lstlisting}

Si l'usage des sons n'est pas désiré, il suffit de lancer \noun{qmake} avec la configuration suivante:

\begin{lstlisting}
CONFIG += NOSOUND
\end{lstlisting}

\section{Écriture d'un programme}

Les fonctions fournies par la librairie sont définies dans \texttt{src/ctrain\_handler.h
}(\emph{listing} \ref{lst_ctrainhandler}).


%\newcommand{\ccode}[1]{\lstinline{#1}}
%\newcommand{\cfunction}[1]{\ccode{#1}}
%\newcommand{\param}[4]{\ccode{#1} & \ccode{#2} & \ccode{#3} & #4 \\ }
%\cfunction{void afficher_message(const char* message)}
%\newenvironment{listparam}{\begin{tabularx}{\textwidth}{cccX}}{\end{tabularx}}

%\begin{tabularx}{\textwidth}{cccX}
%\toprule
%\textbf{Paramètre} & \textbf{type} & \textbf{return} & \textbf{Description} \\
%\midrule
%\param{message}{const char *}{void}{Chaine de caractère contenant le message à afficher.}
%\bottomrule
%\end{tabularx}

\lstinputlisting[caption={ctrain\_handler.h},label={lst_ctrainhandler},language=C,style=stdCode]{../../QtrainSim/src/ctrain_handler.h}


Le \emph{listing} \ref{lst_min_main_cpp} montre un fichier source minimal
pour l'utilisation de la librairie via du C++. On remarque l'inclusion \ccode{#include "ctrain_handler.h"} qui fournit l'accès au fonctions. L'appel à \ccode{init_maquette()}
et \ccode{mettre_maquette_hors_service()} sont à effectuer obligatoirement
en début et fin de programme.

\lstinputlisting[caption={Fichier source C++ minimal},label={lst_min_main_cpp},language=C++,style=stdCode]{lst/main_minimal.cpp}


Le \emph{listing} \ref{lst_min_main} montre un fichier source minimal
pour l'utilisation de la librairie via du C.

\lstinputlisting[caption={Fichier source C minimal},label={lst_min_main},language=C,style=stdCode]{lst/main_minimal.c}


Une classe \ccode{Locomotive} a toutefois été créée et permet d'accéder aux fonctions de gestion des locomotives via ses méthodes. Elle est disponible dans les sources et peut être utilisée de la manière montrée sur le listing \ref{lst_min_main_loco_cpp}.

\lstinputlisting[caption={student\_cpp/cppmain.cpp},label={lst_min_main_loco_cpp},language=C,style=stdCode]{../../QtrainSim/src/student_cpp/cppmain.cpp}

\chapter{Utilisation}


\section{Généralité}

Pour programmer le comportement des locomotives dans QTrainSim, il
faut utiliser le langage C ou C++ (possibilité d'utiliser la librairie Qt). Toutes les fonctions nécessaires se trouvent dans
l'API représetée par le fichier \file{ctrain\_handler.h}.
Ces fonctions peuvent être appelées directement et sans préfixe depuis
\file{cmain.c} ou \file{cmaincpp.cpp}. En aucun cas il n'est nécessaire, ni même
souhaitable de modifier les autres fichiers du projet. En cas de modification,
il faut savoir que le programme pourrait ne pas fonctionner sur la
maquette physique.

Le simulateur se lance directement à partir de \noun{QtCreator}. Afin
d'indiquer au simulateur la maquette et les locomotives à utiliser,
les fonction \ccode{selection_maquette()} et \ccode{assigner_loco()} doivent
être appelées à l'intérieur de la fonction \ccode{cmain()} du fichier
\texttt{cmain.c}.


\section{Interface graphique}

La figure \ref{fig_interface} représente l'interface graphique dans
son integralité.

%
\begin{figure}[H]
\noindent \begin{centering}
\includegraphics[scale=0.35]{fig/interface}
\par\end{centering}

\caption{Interface graphique du simulateur\label{fig_interface}}

\end{figure}



\subsection{Barre de menu}

\newcommand{\menu}[1]{\textbf{#1}}
\newcommand{\menuitem}[1]{\textbf{#1}}
%\newcommand{\submenu}[2]{\fbox{\textbf{#1$\rightarrow$#2}}}
\newcommand{\submenu}[2]{\textbf{#1$\rightarrow$#2}}

\subsubsection{File}

\begin{itemize}
\item \submenu{File}{Print} permet d'imprimer la vue de la maquette en cours.
\item \submenu{File}{Exit} permet de quitter l'application.
\end{itemize}

\subsubsection{Actions}

Le menu \menu{Actions} de la barre de menu permet d'interagir directement
sur la vue contenant la maquette virtuelle du simulateur. Voici les
différentes actions définies :
\begin{itemize}
\item \submenu{Actions}{Resume/Pause} permet de démarrer ou mettre en pause
le système en fonction de l'état de celui-ci. Cette action n'est applicable qu'en simulation, qui doit notamment être lancée via ce biais. Sur la maquette l'expérience débute immédiatement au lancement du programme.
\item \submenu{Actions}{Emergency stop} fait appelle à la fonction \ccode{emergency\_stop()} située à l'intérieur du fichier \texttt{cmain.c} (ou \file{cppmain.cpp}). C'est la responsabilité de l'utilisateur de placer le code spécifique à cet appel.
\item \submenu{Actions}{Pause loco n/Restart loco n} permettent de mettre en
pause ou de redémarrer une locomotive spécifique représentée par le
numéro $n$ en fonction de son état actuel.
\end{itemize}

\subsubsection{Views}
Le menu \menu{Views} de la barre de menu permet d'intéragir directement
sur la vue contenant la maquette virtuelle du simulateur et les vues
relatives aux logs des locomotives. Voici les différentes actions
définies pour ces vues :
\begin{itemize}
\item \submenu{Views}{Zoom in} permet de réaliser un zoom progressif au sein de la
vue contenant la maquette virtuelle du simulateur.
\item \submenu{Views}{Zoom out} permet de réaliser un zoom regressif au sein de la
vue contenant la maquette virtuelle du simulateur.
\item \submenu{Views}{Zoom fit} permet de dimensionner la maquette virtuelle du simulateur
au sein de sa vue en fonction de la taille de l'application.
\item \submenu{Views}{Rotate +} permet de réaliser une légère rotation de la maquette
virtuelle du simulateur sur la droite.
\item \submenu{Views}{Rotate -} permet de réaliser une légère rotation de la maquette
virtuelle du simulateur sur la gauche.
\item \submenu{Views}{View Loco logs} permet d'afficher ou non les logs des locomotives
dans leur vue respective.
\item \submenu{Views}{View contact number} permet d'afficher à proximité de chaque
contact son numéro.
\item \submenu{Views}{View aiguillage number} permet d'afficher à proximité de chaque
aiguillage son numéro.
\end{itemize}

\subsubsection{Settings}
Le menu \menu{Settings} de la barre de menu permet d'interagir sur
différents paramètres de l'application. Actuellement, il est existe
uniquement l'action \submenu{Settings}{Inertia} qui permet d'ajouter ou non de
l'inertie lors de l'arrêt des locomotives. En pratique, activer l'inertie
permet une simulation plus fidèle aux conditions réelles. Les locos
changeront alors leurs vitesses de manière progressives. Cela est
notamment important dans la gestion des distances de freinage.


\subsection{Barre d'outils}

La barre d'outils offre différents raccourcis pour les actions \menuitem{Resume/Pause},
\menuitem{Emergency stop} , \menuitem{Zoom in} , \menuitem{Zoom out} et \menuitem{Pause
loco n/Restart loco n}.


\subsection{Maquette virtuelle}

La maquette est schématisée par une vue en deux dimension. Les voies
variables (aiguillages, aiguillages enroulés, aiguillages triples,
traversées-jonctions) sont représentées avec une voie en noir (qui
indique l'orientation actuelle de la voie) et une
ou plusieurs voies grisées. La où les locomotives sont représentées
par un rectangle de couleur portant le numéro de la locomotive aux
deux extrémités. Deux triangles jaunes représentent les phares, et
indiquent la direction de la locomotive. Les couleurs des locomotives
sont générées dynamiquement de manière à ce qu'elles
soient le plus distinguables possible. Les contacts sont indiqués
par des disques bleus. Il est possible de modifier l'orientation
d'une voie variable en cliquant directement sur celle-ci. 


\subsection{Console générale}

La console générale offre un journal des informations de toutes les
locomotives dans l'ordre chronologique. 

Il est possible d'y afficher des messages en appelant la fonction \ccode{afficher_message()}.

\subsection{Console locomotive}

Chaque locomotive est également dotée de sa propre console sur la
droite de la fenêtre. Cette console offre un journal des informations
de la locomotive concernée dans l'ordre chronologique.

Il est possible d'y afficher des messages en appelant la fonction \ccode{afficher_message_loco()}, en passant notamment le numéro de la locomotive en paramètre.

\subsection{Interactions}

Il est possible d'agir sur les aiguillages en cliquant dessus. Les aiguillages changent alors de sens, autant en simulation que sur les maquettes réelles.

Lors de l'appel à la fonction \ccode{attendre_contact()}, le contact devient vert et le reste jusqu'à ce qu'une locomotive passe dessus.

Les locomotives peuvent être articifiellement placées en pause en cliquant sur le bouton correspondant. Attention, cette fonctionnalité n'est valable qu'en simulation.

\subsubsection{Entrée utilisateur}

Un champ texte est présent en haut de l'interface utilisateur. Il permet d'entrer du texte qui peut ensuite \^etre récupéré par le contr\^ole des locomotives, via la fonction \ccode{getCommand()} ou la fonction \ccode{getCommandInArray()}. Attention, ces 2 fonctions sont bloquantes.

\chapter{Plan des maquettes}

La figure \ref{fig:maquettea} indique la composition de la maquette A, utilisable sur le simulateur, la figure \ref{fig:maquetteb} celle de la maquette B.

\begin{figure}[!ht]
\centering
\includegraphics[width=.7\textwidth]{fig/maquettea}
\caption{Plan de la maquette A\label{fig:maquettea}}
\end{figure}

\begin{figure}[!ht]
\centering
\includegraphics[width=.7\textwidth]{fig/maquetteb}
\caption{Plan de la maquette B\label{fig:maquetteb}}
\end{figure}

\end{document}
